<!doctype html><html lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><script async src="https://www.googletagmanager.com/gtag/js?id=G-T8HDQQNE6X"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-T8HDQQNE6X")</script><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=description content><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=keywords content><meta property="og:type" content="article"><meta property="og:description" content><meta property="og:title" content="How Bonding Curves Are Crucial to DeFi Protocols"><meta property="og:site_name" content="The Personal Blog of Basil Labib"><meta property="og:image" content><meta property="og:image:type" content="image/jpeg"><meta property="og:image:width" content><meta property="og:image:height" content><meta property="og:url" content="https://basil08.github.io/post/how-bonding-curves-are-crucial-to-defi-protocols/"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2023-07-06
"><meta property="article:modified_time" content="2023-07-06
"><meta name=twitter:card content="summary"><meta name=twitter:site content="@itbwtsh"><meta name=twitter:creator content="@itbwtsh"><meta name=twitter:title content="How Bonding Curves Are Crucial to DeFi Protocols | The Personal Blog of Basil Labib"><meta name=twitter:description content="Source: Google images
After the initial excitement, the current state of DeFi rests with the spawning of a number of speculation and lending markets (such as Compound, AAVE), complementing their traditional counterparts. For a comprehensive bird-eye view of the history of DeFi, I strongly recommend this post by @njess.
Speculation markets work by providing a platform for traders to bet on the value of any digital asset over time. DeFi is experimenting with devising financial instruments like futures and options for digital assets as evident by a number of perpetual futures protocols like Perpetual, dYdX, Mycelium, etc.|"><meta name=twitter:image:src content><meta name=twitter:domain content="https://basil08.github.io/post/how-bonding-curves-are-crucial-to-defi-protocols/"><title>How Bonding Curves Are Crucial to DeFi Protocols</title><link rel=canonical href=https://basil08.github.io/post/how-bonding-curves-are-crucial-to-defi-protocols/><link rel=stylesheet href=https://unpkg.com/tachyons@4.11.1/css/tachyons.min.css><link rel=stylesheet href=https://basil08.github.io/css/style.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/highlightjs@9.12.0/styles/github-gist.css><link rel=stylesheet href=https://basil08.github.io/mycss/custom.css><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=apple-touch-icon href=/apple-touch-icon.png><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script><style>.has-mathjax{visibility:hidden}</style><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script>
<script>window.MathJax={startup:{pageReady:()=>MathJax.startup.defaultPageReady().then(()=>{for(let e of document.getElementsByClassName("has-mathjax"))e.style.visibility="visible"})}}</script></head><body lang=en-us class="sans-serif w-90 w-80-m w-60-ns center mv2 mv5-ns" itemscope itemtype=http://schema.org/Article><span class=b>/</span>
<a href=https://basil08.github.io/ class="b bb bw1 pb1 no-underline black">The Personal Blog of Basil Labib</a>
<span class=b>/</span>
<a href=/post class="b bb bw1 pb1 no-underline black">blog</a><section id=main class=mt5><h1 itemprop=name id=title>How Bonding Curves Are Crucial to DeFi Protocols</h1><span class="f6 gray">July 6, 2023</span><article itemprop=articleBody id=content class="w-90 lh-copy"><div style=text-align:center><figure><img src=/img/bc/0.jpg alt="Source: Google images" height=200px><figcaption><p>Source: Google images</p></figcaption></figure></div><p>After the initial excitement, the current state of DeFi rests with the spawning of a number of speculation and lending markets (such as <a href=https://compound.finance>Compound</a>, <a href=https://aave.com>AAVE</a>), complementing their traditional counterparts. For a comprehensive bird-eye view of the history of DeFi, I strongly recommend <a href=https://medium.com/@njess/defi-101-some-basic-primitives-where-they-came-from-and-why-it-matters-35f8c0cf8557>this post</a> by <a href=http://twitter.com/njess>@njess</a>.</p><p>Speculation markets work by providing a platform for traders to bet on the value of any digital asset over time. DeFi is experimenting with devising financial instruments like futures and options for digital assets as evident by a number of perpetual futures protocols like <a href=https://perp.com>Perpetual</a>, <a href=https://dydx.exchange>dYdX</a>, <a href=https://mycelium.xyz>Mycelium</a>, etc.</p><h2 id=amms-ndash-a-defi-primitive>AMMs – a DeFi primitive</h2><p>However, when the exchange is small and relatively unknown, it is difficult to exchange tokens/assets issued by the exchange for ETH or any stablecoin because one won&rsquo;t be able to find a buyer or seller. In other words, the exchange doesn&rsquo;t have enough <em>liquidity</em>. Of course, the smart contract implementing the exchange protocol will provide the liquidity initially but at what price? In other words, what should be the mechanism for <a href=https://en.wikipedia.org/wiki/Price_discovery>price discovery</a>?</p><p>This was the problem that Uniswap protocol designers were grappling with when they launched Unisocks in 2019, a smart contract to exchange socks but equipped with an automated market maker or AMM. Based on a formula, the contract was able to quote a price for an asset <em>on demand</em>. The Unisock protocol used something like the <span class=has-mathjax>\( x*y = k\)</span>
formula to define the number of x and y in circulation. This ensured that there was always enough of x and y in the contract to trade anytime with anyone. As <a href=http://twitter.com/njess>@njess</a> writes,</p><blockquote><h3 id=very-few-people-realized-the-power-of-having-a-permissionless-market-always-willing-to-trade-not-an-efficient-market-an-_available_-market>&mldr;very few people realized the power of having a permissionless market always willing to trade. Not an efficient market. An <em>available</em> market.</h3></blockquote><p>We&rsquo;ll dive into the math soon but first, we have to ask a deeper question.</p><h2 id=why-should-one-buy-tokens>Why should one buy tokens?</h2><p>For the same reason why one buys any other asset. Because they believe that the asset will appreciate in value overtime. Note that the asset itself doesn&rsquo;t need to have intrinsic value. Things like paper currency notes, or application of oil on canvas paper are absurdly overvalued if one believes their real value are strictly tied to their intrinsic value. Most of the time, value is conferred by other people and tokens are just another such asset albeit digital.</p><p>Infact, web3 protocols are more efficient than traditional finsystems at matching value-valuation levels of an asset if they are well designed as tokens actively incentivise holders towards certain actions. This is an area of active research and people are experimenting with curation markets where they incentivise users to report non-credible, fishy news. Encouraging such positive social behaviour would make such protocols appear valuable and so the tokens would appreciate in value (in other words, get more in demand).</p><h2 id=bonding-curves>Bonding curves</h2><p>In finance, a bonding curve is essentially a <strong>function to describe the relationship between the price and supply of an asset</strong>. Bonding curves are what powers liquidity pools and other exchange protocols. Since exchange is such a fundamental action in DeFi, AMMs are one of the primitives of DeFi.</p><p>A typical bonding curve looks like:</p><p><div class=has-mathjax>$$ y = mx^n $$</div>where m is a curve parameter (to fine-tune the shape) and n is the order of the curve. y is the token price and x is the token supply.</p><figure><img src=/img/bc/1.png alt="The power function for various values of m and n. Source: author, plotted on desmos.com" width=400px><figcaption><p>The power function for various values of m and n. Source: author, plotted on desmos.com</p></figcaption></figure><p>If we take the simplest curve, <span class=has-mathjax>\( y = x \)</span>
which is the bonding curve for our token ABT (Alice-Bob token). Let us see how it affects user behaviour.</p><figure><img src=/img/bc/2.png alt="The area represents the price for the tokens at different supply levels. Source: author, plotted on desmos.com" width=400px><figcaption><p>The area represents the price for the tokens at different supply levels. Source: author, plotted on desmos.com</p></figcaption></figure><p>If Alice buys token when the supply is low, she has to pay a small amount. She bought 3 tokens when the price was 3 ETH and now the tokens in supply is 6 tokens so the token price rises to 6 ETH. Bob notices that the token has increased in demand so he wants to have some of ABT too. He buys 2 ABT for 6 ETH each. Now, Alice can sell her stock of ABT as the token price is higher than her cost price and reap a profit out of it. Meanwhile, Bob would incur a loss if he sells after Alice has sold her stock since the token price is higher than his cost price. Thus, this curve incentivises users to buy early and rewards early adopters.</p><p>I should clarify that the statement &ldquo;He buys 2 ABT for 6 ETH each&rdquo; is not correct but a simplification. Since these are continuous curves, the price of assets are continuously changing, hence the price of ABT would increase for even a <span class=has-mathjax>\( 10^{-18} \)</span>
part change. Thus, to compute the cost for 2 ABT, the contract would actually <strong>compute the area under curve</strong> for the function under appropriate limits. This can be done by good &lsquo;ol integral calculus.</p><div class=has-mathjax>$$ \int mx^n dx = m \int x^n dx = \frac{m}{n+1} x^{n+1} $$</div><p>Let&rsquo;s say that the number of tokens in circulation was t, and we want to buy k more tokens. By putting limits,</p><div class=has-mathjax>$$
p = \left[\frac{m}{n+1} x^{n+1} \right]_t^{t+k} = \frac{m}{n+1}(t+k)^{n+1} - \frac{m}{n+1}t^{n+1}$$
$$ = \frac{m}{n+1}t^{n+1} \left( \frac{(t+k)^{n+1}}{t^{n+1}} - 1 \right)
$$
$$ = \frac{m}{n+1}t^{n+1} \left( \left( 1 + \frac{k}{t} \right)^{n+1} - 1 \right) $$</div><p>By solving for k, we can find the number of tokens that one can trade for p units of ETH or stablecoin, likewise:</p><div class=has-mathjax>$$ k = t \left( \left( \frac{p(n+1)}{t*s^{n+1}} + 1 \right)^{\frac{1}{n+1}} -1 \right) $$</div><p>The problem with the above formula is ofcourse the pesky exponent term which can lead to overflow for large t or n. How can we compute p and k efficiently. We need some math trickery and this is exactly what the bancor formulae are.</p><h2 id=bancor-formula>Bancor formula</h2><p>If we define the initial pool balance that is the cost of going from 0 to t as another variable, say b, then the above expressions can be written as follows:</p><div class=has-mathjax>$$ p = b \left( \left( \frac{k}{t} + 1 \right)^{n+1} - 1 \right) $$
and,
$$ k = t \left( \left( \frac{p}{b} +1 \right)^{\frac{1}{n+1}} - 1 \right) $$</div><p>We still have to compute the exponent but we are getting there, bancor formula introduced another variable called the <code>reserveRatio</code> as follows:</p><div class=has-mathjax>$$ r = \frac{poolBalance}{tokenPrice * tokenSupply} $$
$$ r = \frac{b}{p*t} $$
which is
$$ = \frac{\frac{m}{n+1}t^{n+1}}{(m*t^n)*t} = \frac{1}{n+1} $$</div><p>Thus, the price formula under the bancor parameterisation becomes:</p><div class=has-mathjax>$$ p = b \left( \left( \frac{k}{t} +1 \right)^{\frac{1}{r}} - 1 \right) $$</div><p>If you have had some prior exposure to basic economics then the above bonding curve seems a little disconcerting. Why is the price more when there are more tokens in circulation? Shouldn&rsquo;t the price be more when the tokens are scarce? But think about it for a minute. More tokens in circulation means more demand. It is not like more tokens implies less scarcity.</p><h2 id=sigmoid-functions-as-bonding-functions>Sigmoid functions as bonding functions</h2><p>People coming from ML are already acquainted with the sigmoid function, a friendly little function with a nice shape.</p><div class=has-mathjax>$$ g(x) = \frac{1}{1-e^{-x}} $$</div><p>However, the integral of this function is:</p><div class=has-mathjax>$$ \int\frac{1}{1-e^{-x}}dx = ln(1-e^{-x}) $$</div><p>which is a hairy function to compute on the EVM as an infinite power series has to be summed. Smart contracts ideally cannot implement fancier curves as they cost more gas price to compute on-chain. But there is a similar function with a much nicer integral:</p><div class=has-mathjax>$$ f(x) = \frac{x}{\sqrt{1+x^2}} $$</div><p>and, more importantly,</p><div class=has-mathjax>$$ \int\frac{x}{\sqrt{1+x^2}}dx = \sqrt{1+x^2} $$</div><p>Now, just like m and n in the power bonding function, we can parameterise this function as follows and compute the sigmoid price function:</p><div class=has-mathjax>$$
y = a \left( \frac{(x+b)}{\sqrt{c + (x+b)^2}} -1 \right)
$$</div><p>which when integrated within proper limits yield the following price function:</p><div class=has-mathjax>$$
p = \int_{t}^{t+k} a \left( \frac{(x+b)}{\sqrt{c + (x+b)^2}} -1 \right)dx
$$
$$
= a (\sqrt{c + (t+k+b)^2} + t + k ) - b
$$</div><p>which is much easier to compute.</p><h2 id=price-discovery-mechanism>Price discovery mechanism</h2><p>Quantitatively, the value of a token can be defined as the sum of total cash flow available to the bearer. But this raises many questions such as is it always possible to determine the future cash flow from an asset? If yes, then how to compute that? Traditional pricing techniques have evolved tools to price options and futures such as Black-Sholes formula, etc. but I haven&rsquo;t researched much into that. The precise token design is also affected by the amount of token in circulation. Is it possible to value a token in the future if one allows infinite token minting by design? How to do that? These questions are under active research and no doubt, bonding curves will be an important part of future DeFi protocols.</p><h2 id=problems-with-bonding-curves>Problems with bonding curves</h2><p>Not a problem per se but I just wanted to note that AMMs are useful to provide liquidity to a token when it is in its infancy. But once the token is liquid enough to be traded on the free market at other DEXes, then who sets the price? Well, then the AMM and the free market stay at the same price. Any difference is levelled out by arbitrage.</p><ol><li>Frontrunning a transaction</li></ol><p>Do you remember the case for ABT token above? Well, what if Eve got to know that Alice is about to buy her tokens, somehow places an exact transaction with a higher gas fee to incentivise miners to mine her transaction as oppose to Alice&rsquo;s and then sell her tokens to Alice at a higher price (since the token&rsquo;s price has just increased). One possible solution is limiting the gas fee that one can set for these transactions and <em>always</em> ask buyers/sellers to set it to that value.</p><ol start=2><li>Nested bonding curves compounds risks</li></ol><p>Imagine that ABT is pegged to ETH with a reserve ratio of 50%. Now, Darlene designs a token and pegs it to ABT with a reserve ratio of 10%. The actual reserve ratio is .5 * .1 = .05 or 5% of ETH. Further nesting can result in a highly volatile asset which basically means huge changes in the value of the asset for tiny changes in the value of the underlying asset (ETH in this case). One possible solution is to limit the number of nesting, of course.</p><h2 id=references>REFERENCES</h2><ol><li><a href=https://blog.relevant.community/how-to-make-bonding-curves-for-continuous-token-models-3784653f8b17>How to make continuous bonding token models</a> by Slava Balasanov.</li><li><a href=https://blog.relevant.community/bonding-curves-in-depth-intuition-parametrization-d3905a681e0a>Bonding Curves in Depth: with math</a> by Slava Balasanov.</li><li><a href=https://medium.com/molecule-blog/token-bonding-curve-design-parameters-95d365cbec4f>Token Curve Design by Parameters</a>.</li><li><a href=https://billyrennekamp.medium.com/converting-between-bancor-and-bonding-curve-price-formulas-9c11309062f5>Converting between bonding curve and bancor parameters</a> by billy Rennekamp.</li><li><a href=https://medium.com/linum-labs/ethereum-tokens-explained-ffe9df918008>Ethereum tokens explained</a> by Linum Labs.</li><li><a href=https://medium.com/linum-labs/intro-to-bonding-curves-and-shapes-bf326bc4e11a>Introduction to bonding curves, shapes, and use cases</a> by Linum Labs.</li></ol><div style="border-top:1px solid gray;border-bottom:1px solid gray;padding:1rem;padding-top:0"><div><p><span style=font-size:larger;font-weight:700>Basil</span>
| <a href=https://twitter.com/itbwtsh>@itbwtsh</a></p><p style=margin:0%;color:#1a1818>Tech, Science, Design, Economics, Finance, and Books.<br>Basil blogs about complex topics in simple words.<br>This blog is his passion project.</p></div></div></article><span class="f6 gray mv3" title="Lastmod:  July 6, 2023. Published at: 2023-07-06."></span><div id=gitalk-container></div><script>const gitalk=new Gitalk({clientID:"c9601c094023f1222331",clientSecret:"ca206884cb72513054cfcc368082ed873a0104b2",repo:"blog-gitalk",owner:"basil08",admin:["basil08"],id:location.pathname,distractionFreeMode:!1});gitalk.render("gitalk-container")</script></section><footer><div><p class="f6 gray mt6 lh-copy">© 2020 <a href=https://twitter.com/itbwtsh>Basil Labib</a> | Made with ❤️ using <a href=https://gohugo.io>Hugo</a> & <a href=https://github.com/siegerts/hugo-theme-basic>Basic</a></p></div></footer><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js></script>
<script>hljs.initHighlightingOnLoad()</script></body></html>